<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>GameHub Retro - Selecci√≥n de Juegos</title>
    <link rel="stylesheet" href="retro.css">
    <link rel="stylesheet" href="./jsdos/js-dos.css">
    <script src="./jsdos/js-dos.js"></script>
    <script src="score-tracker.js"></script>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,
    <svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'>
      <circle cx='32' cy='32' r='24' fill='black' stroke='%2300ff88' stroke-width='4'>
        <animate attributeName='stroke-opacity' values='1;0.3;1' dur='2s' repeatCount='indefinite'/>
      </circle>
    </svg>">
</head>
<body>
    
    <div class="grid"></div>

    <header>
        <h1>üéÆ GameHub Retro</h1>
        <button class="logout" id="logoutBtn">Salir</button>
    </header>

    <div class="game-select">
        <div class="game-card">
            <button class="game-btn" onclick="loadGame('doom')">‚ñ∂Ô∏è Jugar DOOM</button>
            <img src="img/doom-thumb.jpg" alt="DOOM" class="game-thumb" onclick="loadGame('doom')">
        </div>
        <div class="game-card">
            <button class="game-btn" onclick="loadGame('wolf')">‚ñ∂Ô∏è Jugar Wolfstein 3D</button>
            <img src="img/wolf-thumb.jpg" alt="wolf" class="game-thumb" onclick="loadGame('wolf')">
        </div>
        <div class="game-card">
            <button class="game-btn" onclick="loadGame('dangerousdave2')">‚ñ∂Ô∏è Jugar Dangerous Dave 2</button>
            <img src="img/dangerous-thumb.jpg" alt="Dangerous" class="game-thumb" onclick="loadGame('dangerousdave2')">
        </div>
        <div class="game-card">
            <button class="game-btn" onclick="loadGame('digger')">‚ñ∂Ô∏è Jugar Digger</button>
            <img src="img/digger-thumb.jpg" alt="digger" class="game-thumb" onclick="loadGame('digger')">
        </div>
        <div class="game-card">
            <button class="game-btn" onclick="loadGame('dukenukem3d')">‚ñ∂Ô∏è Jugar Duke Nukem 3D</button>
            <img src="img/duke3d-thumb.jpg" alt="duke3d" class="game-thumb" onclick="loadGame('dukenukem3d')">
        </div>
        <div class="game-card">
            <button class="game-btn" onclick="loadGame('heroesofmightandmagic2')">‚ñ∂Ô∏è Jugar Heroes of Might and Magic 2</button>
            <img src="img/heroes-thumb.jpg" alt="HEROES" class="game-thumb" onclick="loadGame('heroesofmightandmagic2')">
        </div>
        <div class="game-card">
            <button class="game-btn" onclick="loadGame('lostvikings')">‚ñ∂Ô∏è Jugar Lost Vikings</button>
            <img src="img/lost-thumb.jpg" alt="lostvikings" class="game-thumb" onclick="loadGame('lostvikings')">
        </div>
        <div class="game-card">
            <button class="game-btn" onclick="loadGame('mortalkombat')">‚ñ∂Ô∏è Jugar Mortal Kombat</button>
            <img src="img/mortal-thumb.jpg" alt="mortalkombat" class="game-thumb" onclick="loadGame('mortalkombat')">
        </div>
        <div class="game-card">
            <button class="game-btn" onclick="loadGame('streetfighter2')">‚ñ∂Ô∏è Jugar Street Fighter 2</button>
            <img src="img/street-thumb.jpg" alt="streetfighter2" class="game-thumb" onclick="loadGame('streetfighter2')">
        </div>
        <div class="game-card">
            <button class="game-btn" onclick="loadGame('tetris')">‚ñ∂Ô∏è Jugar Tetris</button>
            <img src="img/tetris-thumb.jpg" alt="Tetris" class="game-thumb" onclick="loadGame('tetris')">
        </div>
    </div>

    <div id="loader"></div>
    <div id="dosbox-container"></div>

    <section id="ranking">
        <h2>üèÜ Clasificaci√≥n de Jugadores - <span id="current-game">DOOM</span></h2>
        <div class="ranking-tabs">
            <button class="ranking-tab active" onclick="switchRanking('doom')">DOOM</button>
            <button class="ranking-tab" onclick="switchRanking('wolf')">Wolfenstein 3D</button>
            <button class="ranking-tab" onclick="switchRanking('dangerousdave2')">Dangerous Dave 2</button>
            <button class="ranking-tab" onclick="switchRanking('digger')">Digger</button>
            <button class="ranking-tab" onclick="switchRanking('dukenukem3d')">Duke Nukem 3D</button>
            <button class="ranking-tab" onclick="switchRanking('heroesofmightandmagic2')">Heroes of Might and Magic 2</button>
            <button class="ranking-tab" onclick="switchRanking('lostvikings')">Lost Vikings</button>
            <button class="ranking-tab" onclick="switchRanking('mortalkombat')">Mortal Kombat</button>
            <button class="ranking-tab" onclick="switchRanking('streetfighter2')">Street Fighter 2</button>  
            <button class="ranking-tab" onclick="switchRanking('tetris')">Tetris</button>
        </div>
        <table>
            <thead>
                <tr><th>Posici√≥n</th><th>Jugador</th><th>Puntuaci√≥n</th><th>Fecha</th></tr>
            </thead>
            <tbody id="ranking-body">
                <tr><td colspan="4">Cargando ranking...</td></tr>
            </tbody>
        </table>
    </section>

    <section id="instructions">
        <h2>üïπÔ∏è Controles</h2>
        <ul>
            <li><b>Movimiento:</b> Flechas o WASD</li>
            <li><b>Disparar:</b> CTRL</li>
            <li><b>Usar / Abrir puertas:</b> ESPACIO</li>
            <li><b>Correr:</b> SHIFT (mantener)</li>
            <li><b>Cambiar arma:</b> 1‚Äì7</li>
            <li><b>Pantalla completa:</b> F11 o bot√≥n del juego</li>
            <li><b>Rat√≥n:</b> clic dentro del juego para capturarlo</li>
        </ul>
    </section>

    <script>
        const API = "http://localhost:8082/api";
        const token = localStorage.getItem("token");
        const username = localStorage.getItem("username");
        const loader = document.getElementById("loader");
        const container = document.getElementById("dosbox-container");
        const rankingBody = document.getElementById("ranking-body");
        let currentRankingGame = "doom";
        let currentScoreSystem = null; // üÜï Sistema de puntuaci√≥n h√≠brido

        // üü¢ MAPA DE T√çTULOS CORREGIDO
        const JUEGOS_TITULOS = {
            "doom": "DOOM",
            "wolf": "Wolfenstein 3D",
            "dangerousdave2": "Dangerous Dave 2",
            "digger": "Digger",
            "dukenukem3d": "Duke Nukem 3D",
            "heroesofmightandmagic2": "Heroes of Might and Magic 2",
            "lostvikings": "Lost Vikings",
            "mortalkombat": "Mortal Kombat",
            "streetfighter2": "Street Fighter 2",
            "tetris": "Tetris"
        };
        // -----------------------------

        if (!token) window.location.href = "./index.html";

        // Cargar ranking inicial al abrir la p√°gina
        loadRanking("doom");

        document.getElementById("logoutBtn").onclick = () => {
            localStorage.clear();
            window.location.href = "./index.html";
        };

        async function saveScore(game, score) {
            try {
                const res = await fetch(`${API}/score`, {
                    method: "POST",
                    headers: {"Content-Type":"application/json","Authorization":`Bearer ${token}`},
                    body: JSON.stringify({game, score})
                });
                const data = await res.json();
                console.log("Puntuaci√≥n guardada:", data);
                
                // Actualizar el ranking despu√©s de guardar
                await loadRanking(game);
            } catch (err) {
                console.error("Error al guardar puntuaci√≥n:", err);
            }
        }

        async function loadRanking(game) {
            try {
                currentRankingGame = game;
                const res = await fetch(`${API}/scores/${game}`);
                const data = await res.json();
                
                // üü¢ CORRECCI√ìN: Usar el mapa de t√≠tulos para el encabezado
                const title = JUEGOS_TITULOS[game] || game.toUpperCase();
                document.getElementById("current-game").textContent = title;
                
                // Actualizar las pesta√±as activas
                document.querySelectorAll(".ranking-tab").forEach(tab => {
                    tab.classList.remove("active");
                });
                // üü¢ CORRECCI√ìN: Usar el valor exacto del juego en el selector
                document.querySelector(`[onclick="switchRanking('${game}')"]`).classList.add("active");
                
                // Actualizar la tabla
                rankingBody.innerHTML = "";
                if (data.length === 0) {
                    rankingBody.innerHTML = '<tr><td colspan="4">No hay puntuaciones todav√≠a</td></tr>';
                } else {
                    data.forEach((r, index) => {
                        const position = index + 1;
                        const emoji = position === 1 ? "ü•á" : position === 2 ? "ü•à" : position === 3 ? "ü•â" : position;
                        const rowClass = r.username === username ? 'class="my-score"' : '';
                        const date = new Date(r.created_at).toLocaleString('es-ES', {
                            day: '2-digit',
                            month: '2-digit',
                            year: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit',
                            timeZone: 'Europe/Madrid'
                        });
                        rankingBody.innerHTML += `<tr ${rowClass}><td>${emoji}</td><td>${r.username}</td><td>${r.score}</td><td>${date}</td></tr>`;
                    });
                }
            } catch (err) {
                console.error("Error al cargar ranking:", err);
                rankingBody.innerHTML = '<tr><td colspan="4">Error al cargar el ranking</td></tr>';
            }
        }

        function switchRanking(game) {
            loadRanking(game);
        }

        async function loadGame(game) {
            if (window.ciInstance && window.ciInstance.exit) {
                try { await window.ciInstance.exit(); } catch {}
            }
            
            // Limpiar tracker anterior si existe
            if (currentScoreSystem) {
                currentScoreSystem.destroy();
            }
            
            container.style.display = "none";
            loader.textContent = `Cargando ${game.toUpperCase()}...`;
            
            // ‚úÖ Se mantiene el mapa de rutas, que ya estaba correcto
            const JUEGOS_RUTAS = {
                "doom": "./juegos/doom.jsdos",
                "wolf": "./juegos/wolf.jsdos",
                "dangerousdave2": "./juegos/dangerousdave2.jsdos", 
                "digger": "./juegos/digger.jsdos",
                "dukenukem3d": "./juegos/duke3d.jsdos",
                "heroesofmightandmagic2": "./juegos/heroesofmightandmagic2.jsdos",
                "lostvikings": "./juegos/lostvikings.jsdos",
                "mortalkombat": "./juegos/mortalkombat.jsdos",
                "streetfighter2": "./juegos/streetfighter2.jsdos",
                "tetris": "./juegos/tetris.jsdos" 
            };

            const url = JUEGOS_RUTAS[game] || "./juegos/default.jsdos";

            // Cargar el ranking del juego que se va a jugar
            await loadRanking(game);

            try {
                const ci = await Dos(container, {url, pathPrefix:"./jsdos/", mouseLock:true});
                window.ciInstance = ci;
                
                // üÜï Iniciar sistema h√≠brido de puntuaci√≥n
                currentScoreSystem = new HybridScoreSystem(game, ci);
                console.log(`üéÆ Tracking de puntuaci√≥n iniciado para ${game.toUpperCase()}`);
                
                loader.textContent = "";
                container.style.display = "block";

                ci.exit = async () => {
                    console.log(`üèÅ Juego terminado, calculando puntuaci√≥n...`);
                    
                    // üÜï Obtener puntuaci√≥n (autom√°tica o manual seg√∫n tiempo jugado)
                    const score = await currentScoreSystem.getFinalScore();
                    console.log(`üìä Puntuaci√≥n final: ${score}`);
                    
                    await saveScore(game, score);
                    
                    // Limpiar sistema de puntuaci√≥n
                    currentScoreSystem.destroy();
                    currentScoreSystem = null;
                };
            } catch (err) {
                loader.textContent = "";
                console.error("Error al cargar juego:", err);
            }
        }
    </script>
</body>
</html>